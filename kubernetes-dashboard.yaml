package:
  name: kubernetes-dashboard
  version: 7.8.0
  epoch: 1
  description: General-purpose web UI for Kubernetes clusters
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - busybox
      - corepack
      - curl
      - nodejs
      - npm
      - perl
      - posix-libc-utils
  environment:
    COREPACK_ENABLE_DOWNLOAD_PROMPT: 0

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kubernetes/dashboard
      tag: kubernetes-dashboard-${{package.version}}
      expected-commit: 28539a32f10353285eb616446684feeca664583c

  - uses: go/build
    with:
      go-package: go
      modroot: ./modules/web
      packages: .
      ldflags: -X main.version=${{package.version}} -X main.gitCommit=$(git rev-parse HEAD)
      output: /usr/share/kubernetes-dashboard/dashboard

  - working-directory: modules/web
    # **TODO:** Dev notes for triage, do not merge this comment with final changes.
    # The upstream project defines 'yarn' v3.3.0 here:
    # - https://github.com/kubernetes/dashboard/blob/kubernetes-dashboard-7.8.0/modules/web/.yarnrc.yml
    #
    # Our 'yarn' package in wolfi is for v1.x, which looks to be EOL. So there
    # will be separate packaging work / considerations needed here for yarn.
    #
    # yarn v2 and later, recommend using `corepack` to download and set the
    # correct yarn version. Because this project has a `.yarnrc` file, this
    # means if we enable corepack then run `yarn install`, it'll download the
    # correct version (public binary) for the project to run. This is what we
    # are trying to do here.
    #
    # The goal here was to try and resolve melange build failures:
    # typescript@patch:typescript@npm%3A5.4.3#~builtin<compat/typescript>::version=5.4.3&hash=d73830: The remote archive doesn't match the expected checksum
    # typescript@patch:typescript@npm%3A5.1.6#~builtin<compat/typescript>::version=5.1.6&hash=d73830: The remote archive doesn't match the expected checksum
    runs: |
      corepack enable
      yarn cache clean --all
      yes | yarn up --mode update-lockfile
      yarn install

      mkdir -p "${{targets.destdir}}"/usr/share/kubernetes-dashboard
      mv .dist/* "${{targets.destdir}}"/usr/share/kubernetes-dashboard/
      mv "${{targets.destdir}}"/usr/share/kubernetes-dashboard/dashboard-web "${{targets.destdir}}"/usr/share/kubernetes-dashboard/dashboard
      ln -sf /usr/share/kubernetes-dashboard/dashboard "${{targets.destdir}}"/usr/share/kubernetes-dashboard/dashboard

  - uses: strip

test:
  environment:
    contents:
      packages:
        - curl
  pipeline:
    - uses: test/kwok/cluster
    - name: Verify kubernetes-dashboard installation
      runs: |
        /usr/share/kubernetes-dashboard/dashboard  --insecure-bind-address=0.0.0.0 --bind-address=0.0.0.0 --kubeconfig=/root/.kube/config &
        sleep 5
        curl http://0.0.0.0:8000 | grep "Kubernetes Dashboard" || exit 1

update:
  enabled: true
  github:
    identifier: kubernetes/dashboard
    strip-prefix: kubernetes-dashboard-
    tag-filter: kubernetes-dashboard-
